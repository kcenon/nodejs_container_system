name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on Node.js ${{ matrix.node-version }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Build project
      run: npm run build

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Upload coverage to Codecov (Node 20.x only)
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v4
      with:
        fail_ci_if_error: false
        verbose: true

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Check for build artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "Error: dist directory not created"
          exit 1
        fi
        echo "Build artifacts verified"

    - name: Verify TypeScript compilation
      run: npx tsc --noEmit

  quality-check:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Check formatting
      run: |
        if npm run format -- --check 2>&1 | grep -q "Code style issues"; then
          echo "Warning: Code style issues found. Run 'npm run format' to fix."
          exit 0
        fi

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Verify coverage thresholds
      run: |
        echo "Coverage thresholds:"
        echo "- Branches: 80%"
        echo "- Functions: 80%"
        echo "- Lines: 80%"
        echo "- Statements: 80%"

        # Jest will exit with non-zero if coverage thresholds are not met
        # This is handled automatically by jest.config.js
